{% extends "base.html" %}
{% block title %}Chat Â· Hot Singles Chat{% endblock %}

{# Expose the role for client-side logic (mods get delete, etc.) #}
{% block body_data %}data-role="{{ role|e }}"{% endblock %}

{% block extra_head %}
<style>
  :root {
    --bg: #0f172a;         /* slate-900 */
    --panel: #111827;      /* gray-900 */
    --panel-2: #0b1222;    /* deep navy */
    --text: #e5e7eb;       /* gray-200 */
    --muted: #9ca3af;      /* gray-400 */
    --primary: #2563eb;    /* blue-600 */
    --accent: #22c55e;     /* green-500 */
    --danger: #ef4444;     /* red-500 */
    --border: #1f2937;     /* gray-800 */
  }

  body { background: var(--bg); color: var(--text); }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:1rem; padding:12px 16px; border-bottom:1px solid var(--border);
    background: linear-gradient(180deg, #0d1426 0%, #0a1020 100%);
    position:sticky; top:0; z-index:5;
  }
  .topbar .btn{
    background:var(--primary); color:white; padding:8px 12px; border-radius:8px;
    text-decoration:none; border:0; display:inline-block;
  }
  .layout{
    display:grid; grid-template-columns: 260px 1fr; gap:16px; padding:16px;
  }
  @media (max-width: 900px){ .layout{ grid-template-columns: 1fr; } }

  .panel{
    background: var(--panel); border:1px solid var(--border);
    border-radius:12px; padding:12px; min-height: 70vh;
  }

  /* Online list */
  .users{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
  .users li{
    display:flex; align-items:center; justify-content:space-between;
    background: var(--panel-2); border:1px solid var(--border); border-radius:10px;
    padding:8px 10px;
  }
  .badge{ font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
  .badge.mod{ color:#ffd166; border-color:#806b00; }

  /* Messages area */
  .messages{
    list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px;
    max-height: 62vh; overflow:auto; border:1px solid var(--border); border-radius:10px;
    background: #0b1222; padding:10px;
  }
  .messages li{
    background:#0e172f; border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }
  .meta{ font-size:.8rem; color:var(--muted); margin-bottom:4px; }
  .msg{ white-space:pre-wrap; word-break:break-word; }

  /* Composer */
  .send{
    display:flex; gap:8px; margin-top:12px; border-top:1px solid var(--border); padding-top:12px;
  }
  #msgInput{
    flex:1; padding:10px; border-radius:10px; border:1px solid var(--border);
    background:#0b1222; color:var(--text);
  }
  #sendForm button, .send button{
    background: var(--accent); border:0; color:#041a0b; padding:10px 14px;
    border-radius:10px; font-weight:700; cursor:pointer;
  }

  /* Hidden heading helper */
  .sr-only{
    position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
    clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
</style>
{% endblock %}

{% block content %}
  <header class="topbar">
    <div>
      Logged in as <strong>{{ username|e }}</strong>
      <span style="opacity:.7;">({{ role|e }})</span>
    </div>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </header>

  <main class="layout" role="main">
    <!-- LEFT: Online users -->
    <section class="panel" aria-labelledby="online-heading">
      <h2 id="online-heading">Online</h2>
      <ul id="users" class="users" aria-live="polite" aria-label="Online users list"></ul>
    </section>

    <!-- RIGHT: Chat stream + composer -->
    <section class="panel" aria-labelledby="chat-heading">
      <h2 id="chat-heading" class="sr-only">
        Chat
      </h2>

      <!-- Message list (chat.js appends here) -->
      <ul id="messages" class="messages" aria-live="polite" aria-label="Messages"></ul>

      <!-- Composer (IDs must match chat.js expectations) -->
      <form id="sendForm" class="send" autocomplete="off">
        <input
          id="msgInput"
          type="text"
          placeholder="Type a message"
          aria-label="Message input"
          autocomplete="off"
          autocapitalize="none"
          spellcheck="false"
          maxlength="500"
        >
        <button type="submit" aria-label="Send message">Send</button>
      </form>

      <!-- Back from DM button (chat.js toggles visibility) -->
      <button
        id="backToChat"
        type="button"
        style="display:none; margin:10px;"
        aria-label="Back to public chat"
      >
        Back to Public Chat
      </button>
    </section>
  </main>
{% endblock %}

{% block extra_scripts %}
  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <!-- Provide role to chat.js (fallback if body dataset isn't read) -->
  <script>window.ROLE = document.body.dataset.role || 'user';</script>

  <!-- OPTIONAL: Emoji picker (if you plan to wire one in chat.js) -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js" crossorigin="anonymous"></script> -->

  <!-- Chat logic (expects #users, #messages, #sendForm, #msgInput, #backToChat) -->
  <script src="{{ url_for('static', filename='chat.js') }}"></script>
{% endblock %}
