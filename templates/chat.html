<!doctype html>
<html lang="en" data-role="{{ role|e }}">
<head>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>

<!-- in <head> or before chat.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js" crossorigin="anonymous"></script>

<!-- ... later, before </body> ... -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>window.ROLE = document.body.dataset.role || 'user';</script>
<script src="{{ url_for('static', filename='chat.js') }}"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#111111">
</head>
<body data-role="{{ role|e }}">
  <header class="topbar">
    <div>Logged in as <strong>{{ username|e }}</strong> ({{ role|e }})</div>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </header>

  <main class="layout">
    <section class="panel">
      <h2>Online</h2>
      <ul id="users" class="users"></ul>
    </section>

    <section class="panel">
      <ul id="messages" class="messages"></ul>
      <form id="sendForm" class="send">
        <input id="msgInput" placeholder="Type a message" autocomplete="off">
        <button type="submit">Send</button>
      </form>
    </section>
  </main>

  <!-- Socket.IO client (use CDN to ensure version compatibility on Render) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <!-- Expose role to chat.js for the mod delete button -->
  <script>
    window.ROLE = document.body.dataset.role || 'user';
  </script>

  <!-- Your existing chat.js (unchanged) -->
  <script src="{{ url_for('static', filename='chat.js') }}"></script>

  <!-- Register service worker if present -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('{{ url_for("sw") }}').catch(()=>{});
    }
  </script>

  <!-- Age Gate -->
<div id="age-gate" style="position:fixed;inset:0;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="max-width:520px;text-align:center;padding:24px;">
    <h2>Adults Only (18+)</h2>
    <p>This site may display adult advertising. By entering, you confirm you are 18+ and consent to cookies.</p>
    <button id="enterBtn">Enter</button>
  </div>
</div>
<script>
(function(){
  const COOKIE = "age_ok";
  // make the cookie work on both apex and www
  const ROOT_DOMAIN = location.hostname.replace(/^www\./,'');
  const COOKIE_DOMAIN = "." + ROOT_DOMAIN;

  const gate = document.getElementById("age-gate");
  const enter = document.getElementById("enterBtn");

  function hasCookie(){
    return document.cookie.split(";").some(c => c.trim().startsWith(COOKIE + "="));
  }
  function setCookie(days=30){
    const maxAge = 60*60*24*days;
    document.cookie = `${COOKIE}=1; Max-Age=${maxAge}; path=/; domain=${COOKIE_DOMAIN}; SameSite=Lax`;
  }

  // show by default; hide only if cookie is present
  if (hasCookie()){
    gate.style.display = "none";
    document.body.classList.remove("agelock");
  } else {
    gate.style.display = "flex";
    document.body.classList.add("agelock");
    gate.style.zIndex = "99999"; // make sure it's on top
  }

  enter.addEventListener("click", () => {
    setCookie(30);
    gate.style.display = "none";
    document.body.classList.remove("agelock");
  });
})();
</script>

</body>
</html>
