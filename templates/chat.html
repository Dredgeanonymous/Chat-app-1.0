{% extends "base.html" %}

{% block title %}Chat Â· Hot Singles Chat{% endblock %}

{# Expose the role to the DOM so chat.js can read it #}
{% block body_data %}data-role="{{ role|e }}"{% endblock %}

{% block extra_head %}
  <!-- Emoji picker (must load before chat.js uses it) -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js" crossorigin="anonymous"></script>

  <!-- Optional: lock body when age gate shown -->
  <style>.agelock{overflow:hidden}</style>

  <!-- (Optional) Google AdSense loader -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5795465450797264" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
  <header class="topbar">
    <div>Logged in as <strong>{{ username|e }}</strong> ({{ role|e }})</div>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </header>

  <main class="layout">
    <section class="panel">
      <h2>Online</h2>
      <ul id="users" class="users"></ul>
    </section>

    <section class="panel">
      <ul id="messages" class="messages"></ul>
      <form id="sendForm" class="send">
        <input id="msgInput" placeholder="Type a message" autocomplete="off">
        <button type="submit">Send</button>
      </form>
    </section>
  </main>

  <!-- Age Gate -->
  <div id="age-gate" style="position:fixed;inset:0;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;z-index:99999;">
    <div style="max-width:520px;text-align:center;padding:24px;">
      <h2>Adults Only (18+)</h2>
      <p>This site may display adult advertising. By entering, you confirm you are 18+ and consent to cookies.</p>
      <button id="enterBtn" type="button" style="padding:.6rem 1rem;border-radius:.5rem;background:#2563eb;color:#fff;border:0;">Enter</button>
      <noscript style="display:block;margin-top:12px;color:#ffb4b4;">
        JavaScript is required to enter this site.
      </noscript>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <!-- JuicyAds (load once, push one zone) -->
  <script data-cfasync="false" async src="https://poweredby.jads.co/js/jads.js"></script>
  <ins id="1102385" data-width="800" data-height="100"></ins>
  <script data-cfasync="false" async>
    (window.adsbyjuicy = window.adsbyjuicy || []).push({ adzone: 1102385 });
  </script>

  <!-- Infolinks -->
  <script>var infolinks_pid = 3440424; var infolinks_wsid = 0;</script>
  <script src="//resources.infolinks.com/js/infolinks_main.js"></script>

  <!-- Socket.IO client + role exposure for chat.js -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>window.ROLE = document.body.dataset.role || 'user';</script>

  <!-- Your chat logic -->
  <script src="{{ url_for('static', filename='chat.js') }}"></script>

  <!-- Age gate logic -->
  <script data-cfasync="false">
  document.addEventListener('DOMContentLoaded', function () {
    const KEY  = 'age_ok';
    const gate = document.getElementById('age-gate');
    const btn  = document.getElementById('enterBtn');

    function hasConsent() {
      const inStorage = localStorage.getItem(KEY) === '1';
      const inCookie  = document.cookie.split(';').some(c => c.trim().startsWith(KEY + '='));
      return inStorage || inCookie;
    }
    function setConsent(days = 30) {
      const maxAge = 60*60*24*days;
      document.cookie = `${KEY}=1; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
      const host = location.hostname.split('.');
      if (host.length >= 2) {
        const root = '.' + host.slice(-2).join('.');
        document.cookie = `${KEY}=1; Max-Age=${maxAge}; Path=/; Domain=${root}; SameSite=Lax`;
      }
      try { localStorage.setItem(KEY, '1'); } catch(_) {}
    }

    if (hasConsent()) {
      gate.style.display = 'none';
      document.body.classList.remove('agelock');
    } else {
      gate.style.display = 'flex';
      document.body.classList.add('agelock');
    }

    btn?.addEventListener('click', () => {
      setConsent(30);
      gate.style.display = 'none';
      document.body.classList.remove('agelock');
      setTimeout(() => { if (!hasConsent()) location.reload(); }, 50);
    });
  });
  </script>
{% endblock %}
